<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout - Your Jewelry Store</title>
    <!--ICON-->
    <link rel="shortcut icon" href="IMAGES/01.png">
    <style>
        /* Base styles */
        body {
          font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
          background-color: #ffffff;
          margin: 0;
          padding: 40px 20px;
          color: #222;
          line-height: 1.6;
        }

        .checkout-container {
          display: flex;
          flex-direction: row;
          justify-content: space-between;
          max-width: 1200px;
          margin: 0 auto;
          gap: 30px;
        }

        .customer-info,
        .order-summary {
          background-color: #fff;
          padding: 30px;
          border-radius: 6px;
          box-shadow: 0 22px 10px rgba(0, 0, 0, 0.05);
          border-style:solid;
          border-color: rgb(241, 209, 165);
        }

        /* Layout widths */
        .customer-info {
          flex: 2;
          min-width: 0;
        }

        .order-summary {
          flex: 1;
          min-width: 300px;
        }

        /* Section titles */
        .section-title {
          font-size: 20px;
          font-weight: 700;
          margin-bottom: 20px;
          border-bottom: 2px solid rgb(241, 209, 165);
          padding-bottom: 8px;
        }

        /* Form styling */
        form {
          display: flex;
          flex-wrap: wrap;
          gap: 20px;
        }

        .form-group {
          flex: 1 1 45%;
          display: flex;
          flex-direction: column;
        }

        .form-group.full-width {
          flex: 1 1 100%;
        }

        label {
          font-size: 17px;
          font-weight: 600;
          margin-top: 20px;
        }

        input[type="text"],
        input[type="email"],
        input[type="tel"],
        select {
          width: 100%;
          max-width: 280px;
          padding: 8px 10px;
          border: 1px solid #aaa;
          border-radius: 4px;
          font-size: 14px;
          background-color: #fff;
        }

        input:focus,
        select:focus {
          outline: none;
          border-color: #cc0000;
          box-shadow: 0 0 0 2px rgba(204, 0, 0, 0.2);
        }

        input[type="radio"] {
          margin-right: 8px;
        }

        #credit-card-info {
          margin-top: 10px;
        }

        /* Cart items */
        .cart-item {
          display: flex;
          justify-content: space-between;
          align-items: center;
          border-bottom: 1px solid #ddd;
          padding: 10px 0;
        }

        .cart-item-img {
          width: 60px;
          height: auto;
          margin-right: 10px;
        }

        .cart-item-details {
          flex-grow: 1;
          margin-left: 10px;
        }

        .cart-item-title {
          font-size: 16px;
          margin: 0 0 5px;
        }

        .cart-item-qty {
          font-size: 14px;
          color: #555;
        }

        /* Summary rows */
        .summary-row {
          display: flex;
          justify-content: space-between;
          margin-bottom: 10px;
        }

        .summary-total {
          font-weight: 700;
          font-size: 16px;
          border-top: 1px solid #ccc;
          padding-top: 10px;
          margin-top: 10px;
        }

        /* Button */
        .checkout-btn {
          display: inline-block;
          background-color: rgb(241, 209, 165);
          color: #000000;
          font-weight: bold;
          border: none;
          padding: 15px;
          width: 100%;
          border-radius: 4px;
          cursor: pointer;
          margin-top: 10%;
          transition: background-color 0.2s ease-in-out;
        }

        .checkout-btn:hover {
          background-color: #000;
          color: #fff;
        }

        button:disabled {
          background-color: #999;
          cursor: not-allowed;
        }

        /* PIN Code Verification Styles */
        .pin-status {
          margin-top: 5px;
          font-size: 14px;
          display: none;
        }

        .pin-valid {
          color: green;
        }

        .pin-invalid {
          color: red;
        }

        .pin-loading {
          color: #666;
        }

        /* City field with loading indicator */
        .city-container {
          position: relative;
        }

        .city-loading {
          position: absolute;
          right: 10px;
          top: 50%;
          transform: translateY(-50%);
          width: 16px;
          height: 16px;
          border: 2px solid #f3f3f3;
          border-top: 2px solid rgb(241, 209, 165);
          border-radius: 50%;
          animation: spin 1s linear infinite;
          display: none;
        }

        /* Error message styles */
        .error-message {
          font-size: 12px;
          color: #cc0000;
          margin-top: 5px;
          display: none;
        }

        @keyframes spin {
          0% { transform: translateY(-50%) rotate(0deg); }
          100% { transform: translateY(-50%) rotate(360deg); }
        }

        /* Responsive layout */
        @media (max-width: 900px) {
          .checkout-container {
            flex-direction: column;
          }

          form {
            flex-direction: column;
          }

          .form-group {
            flex: 1 1 100%;
            max-width: 100%;
          }
        }
        .payment-logos {
            margin-top: 15px;
            display: flex;
            justify-content: space-evenly;
            align-items: center;
            gap: 10px;
        }

        .payment-logos img {
            height: 50px;
            object-fit: cover;
            opacity: 0.9;
        }

        /* State/District field */
        .state-container {
          position: relative;
        }

        #state {
          background-color: #f9f9f9;
        }

        /* Policy links - Horizontal inline version */
        .policy-links {
            margin-top: 20px;
            display: flex;
            flex-direction: row; /* Changed from column to row */
            flex-wrap: wrap; /* Allows wrapping if needed */
            gap: 15px; /* Increased gap for better horizontal spacing */
            font-size: 12px;
            justify-content: center; /* Centers the links horizontally */
        }

        .policy-links a {
            color: #666;
            text-decoration: none;
            transition: color 0.2s;
            white-space: nowrap; /* Prevents text from wrapping */
            padding: 0 5px; /* Adds some horizontal padding */
        }

        .policy-links a:hover {
            color: #000;
            text-decoration: underline;
        }

        /* Optional: Add separator between links */
        .policy-links a:not(:last-child)::after {
            content: "|";
            margin-left: 15px;
            color: #ccc;
        }

        /* Saved Address Styles */
        .saved-addresses {
            margin-bottom: 20px;
        }

        .address-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 15px;
        }

        .address-option {
            display: flex;
            align-items: flex-start;
            gap: 8px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
            position: relative;
            padding-right: 40px;
        }

        .address-option:hover {
            background-color: #f9f9f9;
        }

        .address-option.selected {
            background-color: #f0f0f0;
            border-color: rgb(241, 209, 165);
        }

        .address-text {
            flex: 1;
            font-size: 14px;
            line-height: 1.4;
        }

        .address-text strong {
            display: block;
            margin-bottom: 2px;
        }

        .new-address-btn {
            background-color: transparent;
            border: 1px solid rgb(241, 209, 165);
            color: #333;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-bottom: 15px;
            transition: all 0.2s;
        }

        .new-address-btn:hover {
            background-color: rgb(241, 209, 165);
        }

        .address-form {
            display: none;
        }

        .address-form.active {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
        }

        /* Coupon Code Styles */
        .coupon-section {
            margin-bottom: 20px;
            padding: 15px;
            background-color: #f9f9f9;
            border-radius: 4px;
            border: 1px solid #e0e0e0;
        }

        .coupon-input-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .coupon-input {
            flex: 1;
            padding: 8px 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 14px;
        }

        .apply-coupon-btn {
            background-color: rgb(241, 209, 165);
            color: #000;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: background-color 0.2s;
        }

        .apply-coupon-btn:hover {
            background-color: #000;
            color: #fff;
        }

        .coupon-message {
            margin-top: 8px;
            font-size: 12px;
            display: none;
        }

        .coupon-success {
            color: green;
        }

        .coupon-error {
            color: red;
        }

        .coupon-applied {
            background-color: #e8f5e8;
            border-color: #4caf50;
        }

        .discount-row {
            color: green;
            font-weight: 600;
        }

        /* Delete button styles */
        .delete-address-btn {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background-color: #ff4444;
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            z-index: 10;
        }

        .delete-address-btn:hover {
            background-color: #cc0000;
            transform: translateY(-50%) scale(1.1);
        }

        /* Update cancel button styling */
        .new-address-btn.cancel {
            background-color: #ff4444 !important;
            color: white !important;
        }
    </style>
</head>
<body>
    <div class="checkout-container">
        <!-- Customer Information -->
        <div class="customer-info">
            <h2 class="section-title">Customer Information</h2>
            <form id="checkout-form">
                <div class="form-group">
                    <label for="fullname">Full Name</label>
                    <input type="text" id="fullname" required>
                </div>
                
                <div class="form-group">
                    <label for="email">Email</label>
                    <input type="email" id="email" required>
                    <div id="email-error" class="error-message">Please enter a valid email address</div>
                </div>
                
                <div class="form-group">
                    <label for="phone">Phone Number</label>
                    <input type="tel" id="phone" required>
                    <div id="phone-error" class="error-message">Please enter a valid 10-digit Indian mobile number</div>
                </div>
                
                <div class="form-group">
                    <label for="alternate-phone">Alternate Phone Number</label>
                    <input type="tel" id="alternate-phone">
                    <div id="alt-phone-error" class="error-message">Please enter a valid 10-digit Indian mobile number</div>
                </div>
                
                <div class="form-group full-width">
                    <h2 class="section-title">Shipping Address</h2>
                    
                    <!-- Saved Addresses Section -->
                    <div class="saved-addresses" id="saved-addresses">
                        <div class="address-options" id="address-options">
                            <!-- Saved addresses will be loaded here -->
                        </div>
                        <button type="button" class="new-address-btn" id="new-address-btn">+ Add New Address</button>
                    </div>
                </div>
                
                <!-- Address Form (hidden by default if saved addresses exist) -->
                <div class="address-form" id="address-form">
                    <div class="form-group">
                        <label for="address">Street Address</label>
                        <input type="text" id="address" required>
                    </div>

                    <div class="form-group">
                        <label for="zip">PIN Code</label>
                        <input type="text" id="zip" maxlength="6" required>
                        <div id="pin-status" class="pin-status">Verifying...</div>
                    </div>
                    
                    <div class="form-group city-container">
                        <label for="city">City</label>
                        <input type="text" id="city" required readonly>
                        <div class="city-loading" id="city-loading"></div>
                    </div>
                    
                    <div class="form-group state-container">
                        <label for="state">State</label>
                        <input type="text" id="state" readonly>
                    </div>
                    
                    <div class="form-group">
                        <label for="country">Country</label>
                        <select id="country" required disabled>
                            <option value="IN" selected>India</option>
                        </select>
                    </div>
                </div>
            
                <div class="form-group1">
                    <h2 class="section-title">Payment Method</h2>
                    <label>
                        <input type="radio" name="payment" value="credit" checked> Credit Card
                    </label>
                    <label>
                        <input type="radio" name="payment" value="razorpay"> Razorpay
                    </label>
                    <label>
                        <input type="radio" name="payment" value="cod"> COD(Cash On Delivery)
                    </label>
                </div>
                
                <div id="credit-card-info">
                    <div class="form-group">
                        <label for="card-number">Card Number</label>
                        <input type="text" id="card-number" placeholder="1234 5678 9012 3456">
                    </div>
                    
                    <div class="form-group">
                        <label for="card-name">Name on Card</label>
                        <input type="text" id="card-name">
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 35px;">
                        <div class="form-group">
                            <label for="card-expiry">Expiry Date</label>
                            <input type="text" id="card-expiry" placeholder="MM/YY">
                        </div>
                        <div class="form-group">
                            <label for="card-cvv">CVV</label>
                            <input type="text" id="card-cvv" placeholder="123">
                        </div>
                    </div>
                </div>
            </form>
        </div>
        
        <!-- Order Summary -->
        <div class="order-summary">
            <h2 class="section-title">Order Summary</h2>
            
            <div class="order-items" id="order-items">
                <!-- Cart items will be loaded here -->
            </div>
            
            <!-- Coupon Code Section -->
            <div class="coupon-section" id="coupon-section">
                <div class="coupon-input-group">
                    <input type="text" class="coupon-input" id="coupon-input" placeholder="Enter coupon code">
                    <button type="button" class="apply-coupon-btn" id="apply-coupon-btn">Apply</button>
                </div>
                <div class="coupon-message" id="coupon-message"></div>
            </div>
            
            <div class="summary-row">
                <span>Subtotal</span>
                <span>₹<span id="subtotal">0.00</span></span>
            </div>
            
            <div class="summary-row" id="discount-row" style="display: none;">
                <span>Discount (<span id="applied-coupon"></span>)</span>
                <span class="discount-row">-₹<span id="discount">0.00</span></span>
            </div>
            
            <div class="summary-row">
                <span>Shipping</span>
                <span>₹<span id="shipping">10.00</span></span>
            </div>
            
            <div class="summary-row">
                <span>Tax</span>
                <span>₹<span id="tax">0.00</span></span>
            </div>
            
            <div class="summary-row summary-total">
                <span>Total</span>
                <span>₹<span id="total">0.00</span></span>
            </div>
            
            <button class="checkout-btn" id="place-order-btn">Place Order</button>

            <!-- Policy Links -->
            <div class="policy-links">
                <a href="privacy-policy.html" target="_blank">Privacy Policy</a>
                <a href="cancel.html" target="_blank">Cancellation Policy</a>
                <a href="shipping.html" target="_blank">Shipping Policy</a>
            </div>

            <!-- Payment Logos -->
            <div class="payment-logos">
                <img src="images/visa.png" alt="Visa" height="30">
                <img src="images/mastercard.png" alt="MasterCard" height="30">
                <img src="images/paypal.png" alt="PayPal" height="30">
                <img src="images/razoepay.jpeg" alt="Razorpay" height="30">
            </div>
        </div>
    </div>

    <script>
// Global variables
let currentSubtotal = 0;
let currentDiscount = 0;
let appliedCouponCode = '';
let isAddingNewAddress = false;

// Coupon codes database
const couponCodes = {
    'SAVE10': { type: 'percentage', value: 10, minOrder: 500 },
    'FLAT50': { type: 'fixed', value: 50, minOrder: 200 },
    'WELCOME20': { type: 'percentage', value: 20, minOrder: 1000 },
    'FIRST100': { type: 'fixed', value: 100, minOrder: 800 }
};

// Get cart items from localStorage
function getCartItems() {
    try {
        return JSON.parse(localStorage.getItem('cart')) || [];
    } catch (error) {
        console.error('Error loading cart:', error);
        return [];
    }
}

// Generate random order ID
function generateOrderId() {
    const prefix = 'OY';
    const randomNum = Math.floor(100000 + Math.random() * 900000);
    return `#${prefix}${randomNum}`;
}

// Store order data for confirmation page
function storeOrderDataForConfirmation(orderData) {
    try {
        // Use in-memory storage instead of localStorage for artifacts
        window.orderConfirmationData = orderData;
        console.log('Order data stored for confirmation:', orderData);
    } catch (error) {
        console.error('Error storing order data:', error);
    }
}

// Main initialization
document.addEventListener('DOMContentLoaded', function() {
    displayCartItems();
    initializeShipping();
    setupPaymentToggle();
    setupPINValidation();
    setupEmailValidation();
    setupPhoneValidation();
    setupSavedAddresses();
    setupCouponCode();
    setupFormSubmission();
});

// ==================== ADDRESS MANAGEMENT ====================
function setupSavedAddresses() {
    const savedAddresses = getSavedAddresses();
    const newAddressBtn = document.getElementById('new-address-btn');
    const addressForm = document.getElementById('address-form');
    
    // Always render saved addresses first
    renderSavedAddresses(savedAddresses);
    
    // If no saved addresses, show form immediately
    if (savedAddresses.length === 0) {
        addressForm.classList.add('active');
        isAddingNewAddress = true;
        newAddressBtn.textContent = 'Cancel';
        newAddressBtn.classList.add('cancel');
    }
    
    // New address button handler
    if (newAddressBtn) {
        newAddressBtn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            if (!isAddingNewAddress) {
                // Show form mode
                resetAddressForm();
                deselectAllAddresses();
                addressForm.classList.add('active');
                this.textContent = 'Cancel';
                this.classList.add('cancel');
                isAddingNewAddress = true;
            } else {
                // Cancel mode
                addressForm.classList.remove('active');
                this.textContent = '+ Add New Address';
                this.classList.remove('cancel');
                isAddingNewAddress = false;
                
                // Re-select first saved address if available
                const savedAddrs = getSavedAddresses();
                if (savedAddrs.length > 0) {
                    selectAddress(0);
                }
            }
        });
    }
}

function deleteAddress(index) {
    if (confirm('Are you sure you want to delete this address?')) {
        let savedAddresses = getSavedAddresses();
        savedAddresses.splice(index, 1);
        
        try {
            // Save to memory instead of localStorage for demonstration
            window.savedAddressesData = savedAddresses;
            renderSavedAddresses(savedAddresses);
            
            if (savedAddresses.length === 0) {
                document.getElementById('address-form').classList.add('active');
                document.getElementById('new-address-btn').textContent = 'Cancel';
                document.getElementById('new-address-btn').classList.add('cancel');
                isAddingNewAddress = true;
                resetAddressForm();
            } else {
                selectAddress(0);
            }
        } catch (e) {
            console.error('Error deleting address:', e);
            alert('Error deleting address. Please try again.');
        }
    }
}

function getSavedAddresses() {
    // Use in-memory storage for demo purposes
    return window.savedAddressesData || [
        {
            address: "123 MG Road",
            zip: "411001",
            city: "Pune",
            state: "Maharashtra"
        },
       
    ];
}

function renderSavedAddresses(savedAddresses) {
    const addressOptions = document.getElementById('address-options');
    
    if (savedAddresses.length > 0) {
        let html = '';
        savedAddresses.forEach((address, index) => {
            html += `
                <div class="address-option" data-index="${index}">
                    <input type="radio" name="saved-address" value="${index}" ${index === 0 ? 'checked' : ''}>
                    <div class="address-text">
                        <strong>Address ${index + 1}</strong>
                        ${address.address}, ${address.city}, ${address.state} - ${address.zip}
                    </div>
                    <button type="button" class="delete-address-btn" data-index="${index}" title="Delete Address">
                        ×
                    </button>
                </div>
            `;
        });
        addressOptions.innerHTML = html;
        
        // Add event listeners after rendering
        setTimeout(() => {
            document.querySelectorAll('.address-option').forEach((option, optIndex) => {
                const index = parseInt(option.dataset.index);
                
                // Click handler for the entire option (excluding delete button)
                option.addEventListener('click', function(e) {
                    if (!e.target.classList.contains('delete-address-btn')) {
                        selectAddress(index);
                    }
                });
                
                // Radio button handler
                const radio = option.querySelector('input[type="radio"]');
                if (radio) {
                    radio.addEventListener('click', function(e) {
                        e.stopPropagation();
                        selectAddress(index);
                    });
                }
                
                // Delete button handler
                const deleteBtn = option.querySelector('.delete-address-btn');
                if (deleteBtn) {
                    deleteBtn.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        deleteAddress(index);
                    });
                }
            });
            
            // Select first address by default
            if (!isAddingNewAddress) {
                selectAddress(0);
            }
        }, 100);
        
    } else {
        addressOptions.innerHTML = '<p style="color: #666; font-style: italic;">No saved addresses found</p>';
    }
}

function selectAddress(index) {
    const savedAddresses = getSavedAddresses();
    if (savedAddresses[index]) {
        const address = savedAddresses[index];
        
        // Populate form fields
        document.getElementById('address').value = address.address;
        document.getElementById('zip').value = address.zip;
        document.getElementById('city').value = address.city;
        document.getElementById('state').value = address.state;
        
        // Update UI selection
        document.querySelectorAll('.address-option').forEach((opt, i) => {
            const radio = opt.querySelector('input[type="radio"]');
            if (i === index) {
                opt.classList.add('selected');
                if (radio) radio.checked = true;
            } else {
                opt.classList.remove('selected');
                if (radio) radio.checked = false;
            }
        });
        
        // Hide form and reset button
        document.getElementById('address-form').classList.remove('active');
        const newAddressBtn = document.getElementById('new-address-btn');
        newAddressBtn.textContent = '+ Add New Address';
        newAddressBtn.classList.remove('cancel');
        isAddingNewAddress = false;
    }
}

function deselectAllAddresses() {
    document.querySelectorAll('.address-option').forEach(opt => {
        opt.classList.remove('selected');
        const radio = opt.querySelector('input[type="radio"]');
        if (radio) radio.checked = false;
    });
}

function resetAddressForm() {
    const fields = ['address', 'zip', 'city', 'state'];
    fields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field) {
            field.value = '';
            field.style.borderColor = '';
            field.style.backgroundColor = '';
            if (fieldId === 'city' || fieldId === 'state') {
                field.readOnly = true;
            }
        }
    });
    
    const pinStatus = document.getElementById('pin-status');
    if (pinStatus) {
        pinStatus.style.display = 'none';
    }
}

function saveCurrentAddress() {
    const address = {
        address: document.getElementById('address').value.trim(),
        zip: document.getElementById('zip').value.trim(),
        city: document.getElementById('city').value.trim(),
        state: document.getElementById('state').value.trim()
    };
    
    if (address.address && address.zip && address.city && address.state) {
        let savedAddresses = getSavedAddresses();
        
        // Check for duplicates
        const isDuplicate = savedAddresses.some(saved => 
            saved.address === address.address && 
            saved.zip === address.zip &&
            saved.city === address.city &&
            saved.state === address.state
        );
        
        if (!isDuplicate) {
            savedAddresses.push(address);
            try {
                // Save to memory instead of localStorage for demonstration
                window.savedAddressesData = savedAddresses;
                renderSavedAddresses(savedAddresses);
                selectAddress(savedAddresses.length - 1);
                return true;
            } catch (e) {
                console.error('Error saving address:', e);
                return false;
            }
        } else {
            // If duplicate, still return true and select it
            const duplicateIndex = savedAddresses.findIndex(saved => 
                saved.address === address.address && 
                saved.zip === address.zip &&
                saved.city === address.city &&
                saved.state === address.state
            );
            selectAddress(duplicateIndex);
            return true;
        }
    }
    return false;
}

// ==================== PIN CODE VALIDATION ====================
function setupPINValidation() {
    const zipInput = document.getElementById('zip');
    if (zipInput) {
        zipInput.addEventListener('input', function() {
            const zip = this.value.trim();
            const pinStatus = document.getElementById('pin-status');
            
            if (zip.length === 6) {
                pinStatus.textContent = 'Verifying...';
                pinStatus.className = 'pin-status pin-loading';
                pinStatus.style.display = 'block';
                
                // Simulate API call with timeout
                setTimeout(() => {
                    validatePINCode(zip);
                }, 1000);
            } else if (zip.length > 0 && zip.length < 6) {
                pinStatus.textContent = 'PIN code must be 6 digits';
                pinStatus.className = 'pin-status pin-invalid';
                pinStatus.style.display = 'block';
                document.getElementById('city').value = '';
                document.getElementById('state').value = '';
            } else {
                pinStatus.style.display = 'none';
                document.getElementById('city').value = '';
                document.getElementById('state').value = '';
            }
        });
    }
}

function validatePINCode(zip) {
    const pinStatus = document.getElementById('pin-status');
    const cityInput = document.getElementById('city');
    const stateInput = document.getElementById('state');
    const cityLoading = document.getElementById('city-loading');
    
    // Sample data - in a real app, this would come from an API
    const pinCodeData = {
        '411001': { city: 'Pune', state: 'Maharashtra' },
        '400001': { city: 'Mumbai', state: 'Maharashtra' },
        '110001': { city: 'New Delhi', state: 'Delhi' },
        '600001': { city: 'Chennai', state: 'Tamil Nadu' },
        '700001': { city: 'Kolkata', state: 'West Bengal' },
        '500001': { city: 'Hyderabad', state: 'Telangana' },
        '560001': { city: 'Bengaluru', state: 'Karnataka' }
    };
    
    if (pinCodeData[zip]) {
        cityLoading.style.display = 'block';
        
        // Simulate API delay
        setTimeout(() => {
            cityInput.value = pinCodeData[zip].city;
            stateInput.value = pinCodeData[zip].state;
            cityInput.readOnly = true;
            stateInput.readOnly = true;
            
            pinStatus.textContent = 'Valid PIN code';
            pinStatus.className = 'pin-status pin-valid';
            cityLoading.style.display = 'none';
        }, 800);
    } else {
        pinStatus.textContent = 'Invalid PIN code or not serviceable';
        pinStatus.className = 'pin-status pin-invalid';
        cityInput.value = '';
        stateInput.value = '';
    }
}

// ==================== FORM VALIDATION ====================
function setupEmailValidation() {
    const emailInput = document.getElementById('email');
    const emailError = document.getElementById('email-error');
    
    if (emailInput) {
        emailInput.addEventListener('blur', function() {
            const email = this.value.trim();
            if (email && !validateEmail(email)) {
                emailError.style.display = 'block';
                this.style.borderColor = 'red';
            } else {
                emailError.style.display = 'none';
                this.style.borderColor = '#aaa';
            }
        });
    }
}

function setupPhoneValidation() {
    const phoneInput = document.getElementById('phone');
    const phoneError = document.getElementById('phone-error');
    const altPhoneInput = document.getElementById('alternate-phone');
    const altPhoneError = document.getElementById('alt-phone-error');
    
    if (phoneInput) {
        phoneInput.addEventListener('blur', function() {
            const phone = this.value.trim();
            if (phone && !validateIndianPhone(phone)) {
                phoneError.style.display = 'block';
                this.style.borderColor = 'red';
            } else {
                phoneError.style.display = 'none';
                this.style.borderColor = '#aaa';
            }
        });
    }
    
    if (altPhoneInput) {
        altPhoneInput.addEventListener('blur', function() {
            const phone = this.value.trim();
            if (phone && !validateIndianPhone(phone)) {
                altPhoneError.style.display = 'block';
                this.style.borderColor = 'red';
            } else {
                altPhoneError.style.display = 'none';
                this.style.borderColor = '#aaa';
            }
        });
    }
}

function validateEmail(email) {
    const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return re.test(email);
}

function validateIndianPhone(phone) {
    const re = /^[6-9]\d{9}$/;
    return re.test(phone);
}

// ==================== PAYMENT METHODS ====================
function setupPaymentToggle() {
    const paymentMethods = document.querySelectorAll('input[name="payment"]');
    const creditCardInfo = document.getElementById('credit-card-info');
    
    paymentMethods.forEach(method => {
        method.addEventListener('change', function() {
            if (this.value === 'credit') {
                creditCardInfo.style.display = 'block';
            } else {
                creditCardInfo.style.display = 'none';
            }
        });
    });
}

// ==================== CART DISPLAY ====================
function displayCartItems() {
    const orderItems = document.getElementById('order-items');
    const cartItems = getCartItems(); // Use actual cart data
    let subtotal = 0;
    
    if (cartItems.length > 0) {
        let html = '';
        cartItems.forEach(item => {
            const itemTotal = item.price * item.quantity;
            subtotal += itemTotal;
            
            html += `
                <div class="cart-item">
                    <img src="${item.image}" alt="${item.name}" class="cart-item-img">
                    <div class="cart-item-details">
                        <h4 class="cart-item-title">${item.name}</h4>
                        <div class="cart-item-qty">Qty: ${item.quantity}</div>
                    </div>
                    <div>₹${itemTotal.toLocaleString('en-IN')}</div>
                </div>
            `;
        });
        orderItems.innerHTML = html;
    } else {
        orderItems.innerHTML = '<p>Your cart is empty</p>';
    }
    
    // Update subtotal and total
    currentSubtotal = subtotal;
    document.getElementById('subtotal').textContent = subtotal.toLocaleString('en-IN', { minimumFractionDigits: 2 });
    updateOrderTotal();
}

// ==================== COUPON CODE ====================
function setupCouponCode() {
    const applyBtn = document.getElementById('apply-coupon-btn');
    const couponInput = document.getElementById('coupon-input');
    const couponMessage = document.getElementById('coupon-message');
    const couponSection = document.getElementById('coupon-section');
    
    if (applyBtn) {
        applyBtn.addEventListener('click', function() {
            const code = couponInput.value.trim().toUpperCase();
            
            if (!code) {
                couponMessage.textContent = 'Please enter a coupon code';
                couponMessage.className = 'coupon-message coupon-error';
                couponMessage.style.display = 'block';
                return;
            }
            
            if (appliedCouponCode === code) {
                couponMessage.textContent = 'Coupon already applied';
                couponMessage.className = 'coupon-message coupon-error';
                couponMessage.style.display = 'block';
                return;
            }
            
            if (couponCodes[code]) {
                const coupon = couponCodes[code];
                
                if (currentSubtotal >= coupon.minOrder) {
                    appliedCouponCode = code;
                    
                    if (coupon.type === 'percentage') {
                        currentDiscount = currentSubtotal * (coupon.value / 100);
                    } else {
                        currentDiscount = coupon.value;
                    }
                    
                    // Update UI
                    document.getElementById('discount').textContent = currentDiscount.toLocaleString('en-IN', { minimumFractionDigits: 2 });
                    document.getElementById('applied-coupon').textContent = code;
                    document.getElementById('discount-row').style.display = 'flex';
                    
                    couponMessage.textContent = `Coupon applied successfully! You saved ₹${currentDiscount.toLocaleString('en-IN', { minimumFractionDigits: 2 })}`;
                    couponMessage.className = 'coupon-message coupon-success';
                    couponMessage.style.display = 'block';
                    couponSection.classList.add('coupon-applied');
                    
                    updateOrderTotal();
                } else {
                    couponMessage.textContent = `Minimum order of ₹${coupon.minOrder} required for this coupon`;
                    couponMessage.className = 'coupon-message coupon-error';
                    couponMessage.style.display = 'block';
                }
            } else {
                couponMessage.textContent = 'Invalid coupon code';
                couponMessage.className = 'coupon-message coupon-error';
                couponMessage.style.display = 'block';
            }
        });
    }
}

// ==================== ORDER TOTAL CALCULATION ====================
function updateOrderTotal() {
    const subtotal = currentSubtotal;
    const shipping = parseFloat(document.getElementById('shipping').textContent) || 0;
    const tax = parseFloat(document.getElementById('tax').textContent) || 0;
    const discount = currentDiscount;
    
    const total = subtotal + shipping + tax - discount;
    document.getElementById('total').textContent = total.toLocaleString('en-IN', { minimumFractionDigits: 2 });
}

// ==================== FORM SUBMISSION ====================
function setupFormSubmission() {
    const placeOrderBtn = document.getElementById('place-order-btn');
    const checkoutForm = document.getElementById('checkout-form');
    
    if (placeOrderBtn) {
        placeOrderBtn.addEventListener('click', function(e) {
            e.preventDefault();
            
            if (validateForm()) {
                // Process the order
                processOrder();
            }
        });
    }
}

function validateForm() {
    let isValid = true;
    
    // Validate required fields
    const requiredFields = [
        { id: 'fullname', error: null },
        { id: 'email', error: 'email-error', validator: validateEmail },
        { id: 'phone', error: 'phone-error', validator: validateIndianPhone },
        { id: 'address', error: null },
        { id: 'zip', error: null },
        { id: 'city', error: null },
        { id: 'state', error: null }
    ];
    
    requiredFields.forEach(field => {
        const element = document.getElementById(field.id);
        const errorElement = field.error ? document.getElementById(field.error) : null;
        const value = element.value.trim();
        
        if (!value) {
            isValid = false;
            element.style.borderColor = 'red';
            if (errorElement) errorElement.style.display = 'block';
        } else if (field.validator && !field.validator(value)) {
            isValid = false;
            element.style.borderColor = 'red';
            if (errorElement) errorElement.style.display = 'block';
        } else {
            element.style.borderColor = '#aaa';
            if (errorElement) errorElement.style.display = 'none';
        }
    });
    
    // Validate payment method
    const paymentMethod = document.querySelector('input[name="payment"]:checked').value;
    if (paymentMethod === 'credit') {
        const cardFields = ['card-number', 'card-name', 'card-expiry', 'card-cvv'];
        cardFields.forEach(fieldId => {
            const field = document.getElementById(fieldId);
            if (!field.value.trim()) {
                isValid = false;
                field.style.borderColor = 'red';
            } else {
                field.style.borderColor = '#aaa';
            }
        });
    }
    
    if (!isValid) {
        alert('Please fill in all required fields correctly.');
        return false;
    }
    
    return true;
}

function processOrder() {
    // Save the current address if it's a new one
    if (isAddingNewAddress) {
        if (!saveCurrentAddress()) {
            alert('Error saving address. Please try again.');
            return;
        }
    }
    
    // Get actual cart items
    const cartItems = getCartItems();
    
    // Check if cart is empty
    if (cartItems.length === 0) {
        alert('Your cart is empty. Please add items before checkout.');
        return;
    }
    
    // Collect all order data
    const orderData = {
        orderId: generateOrderId(),
        customer: {
            name: document.getElementById('fullname').value.trim(),
            email: document.getElementById('email').value.trim(),
            phone: document.getElementById('phone').value.trim(),
            altPhone: document.getElementById('alternate-phone').value.trim()
        },
        shipping: {
            address: document.getElementById('address').value.trim(),
            city: document.getElementById('city').value.trim(),
            state: document.getElementById('state').value.trim(),
            zip: document.getElementById('zip').value.trim(),
            country: 'India'
        },
        payment: {
            method: document.querySelector('input[name="payment"]:checked').value,
            details: {}
        },
        items: cartItems, // Use actual cart items
        totals: {
            subtotal: currentSubtotal,
            discount: currentDiscount,
            shipping: parseFloat(document.getElementById('shipping').textContent) || 0,
            tax: parseFloat(document.getElementById('tax').textContent) || 0,
            total: parseFloat(document.getElementById('total').textContent.replace(/,/g, '')) || 0
        },
        coupon: appliedCouponCode ? {
            code: appliedCouponCode,
            discount: currentDiscount
        } : null,
        date: new Date().toISOString()
    };
    
    // Add payment details if credit card
    if (orderData.payment.method === 'credit') {
        orderData.payment.details = {
            cardNumber: document.getElementById('card-number').value.trim(),
            cardName: document.getElementById('card-name').value.trim(),
            cardExpiry: document.getElementById('card-expiry').value.trim(),
            cardCVV: document.getElementById('card-cvv').value.trim()
        };
    }
    
    // Store order data for confirmation page
    storeOrderDataForConfirmation(orderData);
    
    // Clear the cart after successful order
    localStorage.removeItem('cart');
    
    // Redirect to confirmation page
    window.location.href = 'confirmation.html';
}

// ==================== INITIALIZATION ====================
function initializeShipping() {
    // Set default shipping cost
    document.getElementById('shipping').textContent = '100.00';
    
    // Calculate tax (5% of subtotal)
    const tax = currentSubtotal * 0.05;
    document.getElementById('tax').textContent = tax.toLocaleString('en-IN', { minimumFractionDigits: 2 });
    
    // Update total
    updateOrderTotal();
}
</script>
</body>
</html>